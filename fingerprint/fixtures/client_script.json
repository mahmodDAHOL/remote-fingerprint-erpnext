[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Checkin",
  "enabled": 0,
  "modified": "2025-10-19 10:58:41.925481",
  "module": null,
  "name": "Check_In_Attendance",
  "script": "frappe.ui.form.on('Employee Checkin', {\n    after_save: function(frm) {\n        console.log('Employee Checkin:', frm.doc);\n        \n        // Check if the log_type is \"IN\"\n        if (frm.doc.log_type === \"IN\") {\n            let attendance_date = frm.doc.time.split(' ')[0]; // Extract the date\n            console.log('Attendance Date:', attendance_date);\n\n            // Fetch existing attendance record for the employee on that date\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"Attendance\",\n                    filters: {\n                        employee: frm.doc.employee,\n                        attendance_date: attendance_date\n                    },\n                    limit_page_length: 1\n                },\n                callback: function(data) {\n                    console.log('Attendance Records Found:', data.message);\n                    \n                    // Fetch the employee name using the employee ID\n                    frappe.call({\n                        method: \"frappe.client.get\",\n                        args: {\n                            doctype: \"Employee\",\n                            name: frm.doc.employee\n                        },\n                        callback: function(emp_data) {\n                            let employee_name = emp_data.message ? emp_data.message.employee_name : \"Unknown Employee\";\n\n                            if (data.message && data.message.length) {\n                                // Attendance exists, update it\n                                let attendance_doc = data.message[0];\n                                frappe.call({\n                                    method: \"frappe.client.set_value\",\n                                    args: {\n                                        doctype: \"Attendance\",\n                                        name: attendance_doc.name,\n                                        fieldname: {\n                                            \"status\": \"Present\",\n                                            \"check_in\": frm.doc.time // Update check-in time if needed\n                                        }\n                                    },\n                                    callback: function(r) {\n                                        if (!r.exc) {\n                                            frappe.msgprint(__('Attendance updated to Present for employee: {0} at {1}.', [employee_name, frm.doc.time]));\n                                        } else {\n                                            frappe.msgprint(__('Error updating attendance.'));\n                                        }\n                                    }\n                                });\n                            } else {\n                                // Attendance does not exist, create a new one\n                                frappe.call({\n                                    method: \"frappe.client.insert\",\n                                    args: {\n                                        doc: {\n                                            \"doctype\": \"Attendance\",\n                                            \"employee\": frm.doc.employee,\n                                            \"attendance_date\": attendance_date,\n                                            \"status\": \"Present\",\n                                            \"check_in\": frm.doc.time\n                                        }\n                                    },\n                                    callback: function(r) {\n                                        if (!r.exc) {\n                                            frappe.msgprint(__('Attendance recorded as Present for employee: {0} at {1}.', [employee_name, frm.doc.time]));\n                                        } else {\n                                            frappe.msgprint(__('Error creating attendance.'));\n                                        }\n                                    }\n                                });\n                            }\n                        }\n                    });\n                }\n            });\n        } else {\n            console.log('Log type is not IN. Current log type:', frm.doc.log_type);\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Journalist",
  "enabled": 1,
  "modified": "2025-06-03 14:28:30.150683",
  "module": null,
  "name": "add section",
  "script": "frappe.ui.form.on('Journalist', {\n    refresh: function (frm) {\n        frm.button_uiri('Add Section', function () {\n            let section = frm.fields_dict[\"visit\"];\n            section.$wrapper.show();  // Ensure the section is visible\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Visit",
  "enabled": 1,
  "modified": "2025-06-22 12:17:25.459509",
  "module": null,
  "name": "Changing Label",
  "script": "frappe.ui.form.on('Visit', {\n\trefresh(frm) {\n\t    if(frm.fields_dict.role_type === \"Journalist\"){\n\t        frm.fields_dict.role_type.label = \"Solo\";\n        frm.refresh_fields();\n\t    }\n\t        \n\t    \n\t\t\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Media outlet - institution",
  "enabled": 1,
  "modified": "2025-07-10 12:36:06.179029",
  "module": null,
  "name": "RTL - small text",
  "script": "frappe.ui.form.on('Media outlet - institution', {\n\trefresh(frm) {\n\t\tfrm.fields_dict['small_text_cdcx'].$input.css('direction', 'rtl');\n        frm.fields_dict['small_text_cdcx'].$input.css('text-align', 'right');\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Task",
  "enabled": 1,
  "modified": "2025-11-05 12:26:34.554711",
  "module": null,
  "name": "calculate task weight",
  "script": "frappe.ui.form.on(\"Task\", {\r\n    onload(frm) {\r\n        toggleFieldsBasedOnIsGroup(frm);\r\n    },\r\n    refresh(frm) {\r\n        calculateTaskWeight(frm);\r\n    },\r\n\r\n\r\n    depends_on_add(frm, cdt, cdn) {\r\n        calculateTaskWeight(frm);\r\n    },\r\n\r\n    depends_on_remove(frm, cdt, cdn) {\r\n        calculateTaskWeight(frm);\r\n    },\r\n    custom___التعقيد_الفني(frm, cdt, cdn) {\r\n        console.log(\"rrr\")\r\n        calculateTaskWeight(frm);\r\n    },\r\n    expected_time(frm, cdt, cdn) {\r\n        calculateTaskWeight(frm);\r\n    },\r\n    custom_الأولوية_الاستراتيجية(frm, cdt, cdn){\r\n        calculateTaskWeight(frm);\r\n    },\r\n    custom_القيمة_المضافة(frm, cdt, cdn) {\r\n        calculateTaskWeight(frm);\r\n    },\r\n    custom_التأثير_على_الجودة(frm, cdt, cdn) {\r\n        calculateTaskWeight(frm);\r\n    },\r\n\r\n\r\n    priority(frm) {\r\n        calculateTaskWeight(frm);\r\n    },\r\n    is_group(frm) {\r\n        toggleFieldsBasedOnIsGroup(frm);\r\n    }\r\n});\r\n\r\nfunction toggleFieldsBasedOnIsGroup(frm) {\r\n    const isGroup = frm.doc.is_group;\r\n\r\n    // Replace 'your_fieldname' with the actual field you want to hide\r\n    frm.toggle_display(\"expected_time\", !isGroup);\r\n    frm.toggle_display(\"custom_الأولوية_الاستراتيجية\", !isGroup);\r\n    frm.toggle_display(\"custom_القيمة_المضافة\", !isGroup);\r\n    frm.toggle_display(\"custom_التأثير_على_الجودة\", !isGroup);\r\n    frm.toggle_display(\"custom___التعقيد_الفني\", !isGroup);}\r\n\r\nfunction calculateScaledValue(value, maxValue, maxOutput) {\r\n    const clampedValue = Math.max(0, Math.min(maxValue, value));\r\n    const scaled = (clampedValue / maxValue) * maxOutput;\r\n    return Math.round(scaled);\r\n}\r\n\r\n\r\nfunction calculateTaskWeight(frm) {\r\n    if (!frm.doc) return;\r\n\r\n    // Custom field values\r\n    const priorityMap = {'0': 0, '1': 4, '2': 8, '3': 12, '4': 16, '5': 20};\r\n    const comlexityMap = {'0': 0, '1': 8, '2': 16, '3': 24, '4': 32, '5': 40};\r\n    const stratigicPriorityMap = {'0': 0, '1': 4, '2': 8, '3': 12, '4': 16, '5': 20};\r\n    const qualityMap = {'0': 0, '1': 2, '2': 4, '3': 6, '4': 8, '5': 10};\r\n    const addedValueMap = {'0': 0, '1': 2, '2': 4, '3': 6, '4': 8, '5': 10};\r\n\r\n    // Check if it's a group task\r\n    if (frm.doc.is_group && frm.doc.depends_on) {\r\n        let totalDependentWeight = 0;\r\n        let count = 0;\r\n        if(frm.doc.depends_on.length > 0){\r\n        // Loop through dependencies and fetch their weight\r\n        frm.doc.depends_on.forEach((row) => {\r\n            frappe.db.get_value(\"Task\", row.task, \"task_weight\", null, true).then((res) => {\r\n                const weight = res.message?.task_weight || 0;\r\n                totalDependentWeight += weight;\r\n                count += 1;\r\n\r\n        // Once all are fetched, update this task's weight\r\n        if (count === frm.doc.depends_on.length) {\r\n            const averageWeight = totalDependentWeight / count;\r\n\r\n        console.log(\"totalDependentWeight=\"+totalDependentWeight);\r\n        console.log(\"averageWeight=\"+averageWeight);\r\n        console.log(\"count=\"+count);\r\n            frappe.model.set_value(frm.doctype, frm.docname, 'task_weight', averageWeight);\r\n            frm.refresh_field('task_weight');\r\n        }\r\n                \r\n            });\r\n        });\r\n\r\n        }else{\r\n            frappe.model.set_value(frm.doctype, frm.docname, 'task_weight', 0);\r\n            frm.refresh_field('task_weight');\r\n\r\n        }\r\n\r\n    } else {\r\n        // Normal weight calculation for non-group tasks\r\n        const comlexityValue = comlexityMap[frm.doc.custom___التعقيد_الفني] || 0;\r\n        const expectedTimeValue = calculateScaledValue(frm.doc.expected_time, 14, 20);\r\n        const priorityValue = priorityMap[frm.doc.custom_الأولوية_الاستراتيجية] || 0;\r\n        const addedValue = addedValueMap[frm.doc.custom_القيمة_المضافة] || 0;\r\n        const qualityValue = qualityMap[frm.doc.custom_التأثير_على_الجودة] || 0;\r\n\r\n        const weight = priorityValue + comlexityValue + expectedTimeValue + qualityValue + addedValue;\r\n\r\n        frappe.model.set_value(frm.doctype, frm.docname, 'task_weight', weight);\r\n        frm.refresh_field('task_weight');\r\n    }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "request-ceo",
  "enabled": 1,
  "modified": "2025-11-30 10:15:51.118639",
  "module": "MOI",
  "name": "send email from text field",
  "script": "frappe.ui.form.on('request-ceo', {\n    refresh: function(frm) {\n        // Clear existing button to avoid duplicates\n        frm.page.btn_working = false;\n\n        frm.add_custom_button(\"Send Email\", function() {\n            // Get current values from form\n            const recipient = frm.doc.email;\n            const message = frm.doc.suggested;\n            const email_attachments = frm.doc.email_attachments;\n\n            if (!recipient) {\n                frappe.throw(__(\"Recipient email is required.\"));\n                return;\n            }\n\n            frappe.call({\n                method: \"moi_app.api.send_email_from_field\",\n                args: {\n                    'recipient': recipient,\n                    'message': message,\n                    'email_attachments':email_attachments\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        frappe.msgprint(r.message); // Show response\n                    }\n                }\n            });\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "complaint-ceo",
  "enabled": 1,
  "modified": "2025-07-16 13:59:34.051802",
  "module": "MOI",
  "name": "send email from text field -complaint-ceo",
  "script": "frappe.ui.form.on('complaint-ceo', {\n    refresh: function(frm) {\n        // Clear existing button to avoid duplicates\n        frm.page.btn_working = false;\n\n        frm.add_custom_button(\"Send Email\", function() {\n            // Get current values from form\n            const recipient = frm.doc.email;\n            const message = frm.doc.suggested;\n            const email_attachments = frm.doc.email_attachments;\n\n            if (!recipient) {\n                frappe.throw(__(\"Recipient email is required.\"));\n                return;\n            }\n\n            frappe.call({\n                method: \"hrms.api.custom.send_email_from_field\",\n                args: {\n                    'recipient': recipient,\n                    'message': message,\n                    'email_attachments':email_attachments\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        frappe.msgprint(r.message); // Show response\n                    }\n                }\n            });\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Task",
  "enabled": 1,
  "modified": "2025-07-23 13:50:33.922012",
  "module": null,
  "name": "read-only for employee task doctype",
  "script": "frappe.ui.form.on('Task', {\r\n    refresh: function(frm) {\r\n        // Make field read-only by default\r\n        frm.set_df_property('custom___التعقيد_الفني', 'hidden', 0);\r\n        frm.set_df_property('custom_التأثير_على_الجودة', 'hidden', 0);\r\n        frm.set_df_property('custom_القيمة_المضافة', 'hidden', 0);\r\n        frm.set_df_property('custom_الأولوية_الاستراتيجية', 'hidden', 0);\r\n                       // Allow edit only for specific roles\r\n        if (frappe.user.has_role('Employee') && !frappe.user.has_role('Projects User')) {\r\n            frm.set_df_property('subject', 'read_only', 1);\r\n            frm.set_df_property('project', 'read_only', 1);\r\n            frm.set_df_property('priority', 'read_only', 1);\r\n            frm.set_df_property('issue', 'read_only', 1);\r\n            frm.set_df_property('type', 'read_only', 1);\r\n            frm.set_df_property('is_group', 'read_only', 1);\r\n            frm.set_df_property('is_template', 'read_only', 1);\r\n            frm.set_df_property('parent_task', 'read_only', 1);\r\n            frm.set_df_property('completed_by', 'read_only', 1);\r\n            frm.set_df_property('completed_on', 'read_only', 1);\r\n            frm.set_df_property('custom___التعقيد_الفني', 'hidden', 1);\r\n            frm.set_df_property('custom_التأثير_على_الجودة', 'hidden', 1);\r\n            frm.set_df_property('custom_القيمة_المضافة', 'hidden', 1);\r\n            frm.set_df_property('custom_الأولوية_الاستراتيجية', 'hidden', 1);\r\n        }\r\n    }\r\n       \r\n    \r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Attendance",
  "enabled": 1,
  "modified": "2025-11-30 09:45:38.703337",
  "module": "fingerprint",
  "name": "get checkins",
  "script": "frappe.listview_settings['Attendance'] = {\n    onload: function (listview) {\n        // Button 1: Fetch Checkins\n        listview.page.add_button('Fetch Checkins', () => {\n            const d = new frappe.ui.Dialog({\n                title: 'Fetch Checkins',\n                fields: [\n                    {\n                        label: 'Import Start Date',\n                        fieldname: 'import_start_date',\n                        fieldtype: 'Date',\n                        reqd: 1\n                    },\n                    {\n                        label: 'Import End Date',\n                        fieldname: 'import_end_date',\n                        fieldtype: 'Date',\n                        reqd: 1\n                    },\n                ],\n                primary_action_label: 'Fetch',\n                primary_action: function (values) {\n                    frappe.call({\n                        method: 'fingerprint.api.fetch_checkins.fetch_checkins',\n                        args: {\n                            import_start_date: values.import_start_date,\n                            import_end_date: values.import_end_date,\n                        },\n                        freeze: true,\n                        freeze_message: 'Fetching check-ins, please wait...',\n                        callback: function (r) {\n                                    if (!r.exc) {\n            // ✅ Success\n            frappe.msgprint(__('Checkins fetched successfully'));\n            d.hide();\n            listview.refresh();\n        } else {\n            // ❌ Server-side exception occurred\n            let error_msg = r.exc || __('Unknown error occurred');\n            \n            // Improve readability: remove traceback if needed\n            if (error_msg.includes('Traceback')) {\n                // Extract only the actual error (after last \"Exception:\" or \"Error:\")\n                const lines = error_msg.split('\\n');\n                const errorLine = lines.find(line => \n                    line.includes('Exception:') || line.includes('Error:') || line.includes(':')\n                );\n                error_msg = errorLine ? errorLine.trim() : __('Operation failed. Check logs for details.');\n            }\n\n\n            // Show user-friendly error\n            frappe.msgprint({\n                title: __('Fetch Failed'),\n                indicator: 'red',\n                message: __('Failed to fetch check-ins: {0}', [error_msg])\n            });\n\n            // Optional: Log full error in console\n            console.error(\"Fetch checkins error:\", r.exc);\n        }\n                        }\n                    });\n                }\n            });\n            d.show();\n        });\n\n        // Button 2: Mark Attendance with Shift Selection\n        listview.page.add_button('Mark Attendance', () => {\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Shift Type',\n                    fields: ['name'],\n                    order_by: 'name'\n                },\n                callback: function (r) {\n                    if (r.message && r.message.length > 0) {\n                        const shift_options = ['All Shifts'].concat(r.message.map(shift => shift.name));\n\n                        const d = new frappe.ui.Dialog({\n                            title: 'Mark Attendance',\n                            fields: [\n                                {\n                                    label: 'Select Shift Type',\n                                    fieldname: 'shift_type',\n                                    fieldtype: 'Select',\n                                    options: shift_options,\n                                    default: 'All Shifts',\n                                    reqd: 1\n                                },\n                                {\n                                    label: 'Process attendance after',\n                                    fieldname: 'process_attendance_after',\n                                    fieldtype: 'Date',\n                                    reqd: 1\n                                },\n                                {\n                                    label: 'Last sync of checkin',\n                                    fieldname: 'last_sync_of_checkin',\n                                    fieldtype: 'Datetime',\n                                    reqd: 1\n                                },\n                            ],\n                            primary_action_label: 'Process',\n                            primary_action: function (values) {\n                                d.hide();\n\n                                frappe.call({\n                                    method: 'fingerprint.api.mark_attendance.process_auto_attendance_for_all_shifts',\n                                    args: {\n                                        process_attendance_after: values.process_attendance_after,\n                                        last_sync_of_checkin: values.last_sync_of_checkin,\n                                        shift_type: values.shift_type === 'All Shifts' ? '' : values.shift_type\n                                    },\n                                    freeze: true,\n                                    freeze_message: 'Marking attendance, please wait...',\n                                    callback: function (r) {\n                                        if (!r.exc) {\n                                            frappe.msgprint(__('Attendance marked successfully for: {0}', [values.shift_type]));\n                                        } else {\n                                            frappe.msgprint(__('Failed to mark attendance: ') + r.exc);\n                                        }\n                                        // ✅ Refresh List View\n                                        listview.refresh();\n                                    }\n                                });\n                            }\n                        });\n\n                        d.show();\n                    } else {\n                        frappe.msgprint(__('No active Shift Types found. Please create at least one Shift Type.'));\n                    }\n                }\n            });\n        });\n\n        // Button 3: Fetch & Upload\n        listview.page.add_inner_button(__('Fetch & Upload'), async function () {\n            // Load JSZip and FileSaver together\n            loadJSZipAndFileSaver(async function () {\n                const dialog = new frappe.ui.Dialog({\n                    title: 'Enter Credentials',\n                    fields: [\n                        {\n                            label: 'Username',\n                            fieldname: 'username',\n                            fieldtype: 'Data',\n                            reqd: 1\n                        },\n                        {\n                            label: 'Password',\n                            fieldname: 'password',\n                            fieldtype: 'Password',\n                            reqd: 1\n                        }\n                    ],\n                    primary_action_label: 'Generate & Download ZIP',\n                    primary_action: async function (values) {\n                        dialog.hide();\n\n                        const main_file_path = \"/home/moi-mis/frappe-bench/apps/fingerprint/fingerprint/api/get_fingerprint_data.py\";\n                        const extra_file_path = \"/home/moi-mis/frappe-bench/apps/fingerprint/fingerprint/api/run_python.bat\";\n\n                        const zip = new JSZip();\n\n                        try {\n                            // Read and modify main file\n                            const mainRes = await frappe.call({\n                                method: 'fingerprint.api.read_file_from_server.read_server_file',\n                                args: { file_path: main_file_path }\n                            });\n\n                            if (!mainRes.message) throw new Error(\"Main file not loaded\");\n\n                            let mainContent = mainRes.message.content\n                                .replace(/USERNAME/g, values.username)\n                                .replace(/PASSWORD/g, values.password);\n\n                            zip.file(mainRes.message.file_name, mainContent);\n\n                            // Read extra file (optional)\n                            try {\n                                const extraRes = await frappe.call({\n                                    method: 'fingerprint.api.read_file_from_server.read_server_file',\n                                    args: { file_path: extra_file_path }\n                                });\n\n                                if (extraRes.message) {\n                                    zip.file(extraRes.message.file_name, extraRes.message.content);\n                                }\n                            } catch (e) {\n                                frappe.msgprint(__('Extra file not found, continuing...'));\n                            }\n\n                            // Generate and download ZIP\n                            zip.generateAsync({ type: \"blob\" }).then(function (content) {\n                                // ✅ saveAs() is now guaranteed to exist\n                                saveAs(content, \"fingerprint_config_package.zip\");\n                                frappe.msgprint(__('ZIP file generated and downloaded!'));\n                            });\n\n                        } catch (err) {\n                            frappe.msgprint(__('Error: ') + err.message);\n                        }\n                    }\n                });\n\n                dialog.show();\n            });\n        });\nlistview.page.add_inner_button(__('Export to Excel'), async function () {\n            // Load SheetJS\n            loadSheetJS(() => {\n                try {\n                    // ✅ Use listview.data (current filtered/sorted rows)\n                    const data = listview.data;\n\n                    if (!data || data.length === 0) {\n                        frappe.msgprint(__('No data to export'));\n                        return;\n                    }\n\n                    // Map to desired fields\n                    const export_data = data.map(row => ({\n                        'Employee': row.employee,\n                        'Employee Name': row.employee_name,\n                        'Attendance Date': frappe.datetime.str_to_user(row.attendance_date),\n                        'Status': row.status,\n                        'In Time': row.in_time ? row.in_time : '',\n                        'Out Time': row.out_time ? row.out_time : '',\n                        'Working Hours': row.total_working_hours?.toFixed(2),\n                        'Late Entry (Min)': row.custom_late_entry_in_minutes,\n                        'Early Exit (Min)': row.custom_early_exit_in_minutes\n                    }));\n\n                    // Create worksheet\n                    const ws = XLSX.utils.json_to_sheet(export_data);\n\n                    // Create workbook and export\n                    const wb = XLSX.utils.book_new();\n                    XLSX.utils.book_append_sheet(wb, ws, 'Attendance Report');\n                    XLSX.writeFile(wb, `Attendance_Report_${frappe.datetime.get_today()}.xlsx`);\n\n                    frappe.show_alert({\n                        message: __('Exported successfully'),\n                        indicator: 'green'\n                    });\n                } catch (err) {\n                    frappe.msgprint(__('Export failed: ') + err.message);\n                    console.error(\"Export error:\", err);\n                }\n            });\n        });\n    }\n};\n\n// Load SheetJS from CDN\nfunction loadSheetJS(callback) {\n    if (window.XLSX) {\n        callback();\n    } else {\n        const script = document.createElement('script');\n        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';\n        script.onload = () => {\n            console.log('SheetJS loaded');\n            callback();\n        };\n        script.onerror = () => {\n            frappe.msgprint(__('Failed to load Excel library. Check internet connection.'));\n        };\n        document.head.appendChild(script);\n    }\n}\n\n// ✅ Load JSZip and FileSaver.js in correct order\nfunction loadJSZipAndFileSaver(callback) {\n    if (window.JSZip && window.saveAs) {\n        // Already loaded\n        callback();\n    } else {\n        // Load JSZip first\n        loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js', function () {\n            // Then load FileSaver.js\n            loadScript('https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js', function () {\n                if (typeof saveAs !== 'function') {\n                    frappe.throw(__('FileSaver failed to load'));\n                    return;\n                }\n                callback();\n            });\n        });\n    }\n}\n\n// Helper to load script with callback\nfunction loadScript(src, callback) {\n    const script = document.createElement('script');\n    script.src = src;\n    script.onload = callback;\n    script.onerror = () => {\n        frappe.throw(__('Failed to load script: ') + src);\n    };\n    document.head.appendChild(script);\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Attendance",
  "enabled": 1,
  "modified": "2025-08-11 09:54:11.974062",
  "module": null,
  "name": "calculate early exit and late entry",
  "script": "frappe.ui.form.on('Attendance', {\n    after_save: function(frm) {\n        if (frm.is_new()) {\n            calculate_late_entry_and_early_exit(frm);\n        }\n    }\n});\n\nfunction calculate_late_entry_and_early_exit(frm) {\n    if (!frm.doc.shift) {\n        frappe.msgprint(__('Please select a Shift first.'));\n        return;\n    }\n\n    frappe.db.get_doc('Shift Type', frm.doc.shift).then(shift => {\n        if (!shift.start_time || !shift.end_time) {\n            frappe.msgprint(__('Shift Type is missing start or end time.'));\n            return;\n        }\n\n        // Example values\n        const date_str = frm.doc.attendance_date;\n        datetime_str = `${date_str} ${shift.start_time}`;\n        const work_start = new Date(datetime_str); \n        console.log(\"work_start\" + datetime_str);\n\n        datetime_str = `${date_str} ${shift.end_time}`;\n        const work_end = new Date(datetime_str); \n\n        const inTimeStr = frm.doc.in_time;\n        const outTimeStr = frm.doc.out_time;\n\n        if (inTimeStr) {\n            \n            const inTime = frappe.datetime.str_to_obj(inTimeStr);\n            \n            const lateMinutes = Math.max((inTime - work_start) / 60000, 0);\n\n            frm.set_value('custom_late_entry_in_minutes', Math.round(lateMinutes * 10) / 10);\n        }\n\n        if (outTimeStr) {\n            const outTime = frappe.datetime.str_to_obj(outTimeStr);\n            const earlyMinutes = Math.max((work_end - outTime) / 60000, 0);\n            frm.set_value('custom_early_exit_in_minutes', Math.round(earlyMinutes * 10) / 10);\n        }\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "ocr",
  "enabled": 0,
  "modified": "2025-11-30 10:18:57.300538",
  "module": "HR",
  "name": "extraxt text from attachement",
  "script": "// Custom Script for your Doctype (e.g., 'OCR Document' or any doctype with an attachment)\nfrappe.ui.form.on('ocr', {\n    refresh: function(frm) {\n        // Add button only if attachment exists\n        if (frm.doc.attachment) {\n            frm.add_custom_button(\n                \n                __('Extract Text from Image'),    // Button label\n                function() {\n                    frm.trigger('extract_ocr');   // Trigger the OCR function\n                },\n                __('Actions')                    // Section name\n            );\n        } else {\n            frm.add_custom_button(\n                __('Upload Image First'),\n                () => {\n                    frappe.msgprint(__('Please attach an image before extracting text.'));\n                },\n                __('Actions')\n            ).addClass('btn-secondary').prop('disabled', true);\n        }\n    },\n\n    // Define the OCR action (triggered by button)\n    extract_ocr: function(frm) {\n        const file_url = frm.doc.attachment;\n\n        if (!file_url) {\n            frappe.msgprint(__(\"Please attach an image first\"));\n            return;\n        }\n\n        frappe.call({\n            method: 'moi_app.api.extract_text_from_image',  // Your whitelisted method\n            args: {\n                file_url: file_url\n            },\n            freeze: true,\n            freeze_message: __('Processing image with OCR...'),\n            callback: function(r) {\n                if (r.message && r.message.text !== undefined) {\n                    const extracted_text = r.message.text.trim();\n\n                    if (extracted_text) {\n                        // Show success with extracted text\n                        frappe.msgprint({\n                            title: __('OCR: Text Extracted Successfully'),\n                            indicator: 'green',\n                            message: __('Arabic text has been extracted from the image.'),\n                            secondary_message: `\n                                <pre style=\"\n                                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n                                    background: #f8f9fa;\n                                    padding: 12px;\n                                    border-radius: 6px;\n                                    border: 1px solid #ddd;\n                                    max-height: 400px;\n                                    overflow: auto;\n                                    white-space: pre-wrap;\n                                    line-height: 1.5;\n                                \">\n                                    ${frappe.utils.escape_html(extracted_text)}\n                                </pre>\n                            `\n                        });\n\n                        // Save extracted text to a field\n                        frm.set_value('extracted_text', extracted_text);\n                    } else {\n                        frappe.msgprint(__('No text found in the image. Try a clearer image.'));\n                    }\n                } else {\n                    frappe.msgprint(__('OCR failed: ') + (r.exc || 'Unknown error'));\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Inbox",
  "enabled": 1,
  "modified": "2025-11-05 14:22:19.675238",
  "module": null,
  "name": "Media attachment url redirect",
  "script": "// --- OPTIONAL: keep your custom list in an HTML field (if you added it) ---\nfunction getTargetUrl(fileName, stamp, signautre) {\n    const fileNameUri = encodeURIComponent(extract_filename_from_href(fileName));\n\n    let url = `/media-editor/?path=${fileNameUri}`;\n    if (stamp) url += `&stamp=${encodeURIComponent(extract_filename_from_href(stamp))}`;\n    if (signautre) url += `&sign=${encodeURIComponent(extract_filename_from_href(signautre))}`;\n    return url;\n}\n\nasync function get_user_credentials() {\n    try {\n        const user = frappe.session.user;\n        const { message } = await frappe.db.get_value('User', user, ['stamp', 'signature']);\n        return {\n            stamp: message?.stamp || '',\n            signature: message?.signature || ''\n        };\n    } catch (error) {\n        console.error('Failed to fetch user credentials:', error);\n        return { stamp: '', signature: '' };\n    }\n}\n\nasync function render_media_links(frm) {\n    const html = frm.get_field('media_links');\n    if (!html) return;\n\n    const files = (frm.attachments && frm.attachments.get_attachments)\n        ? frm.attachments.get_attachments()\n        : [];\n\n    const items = files\n        .filter(f => !f.is_private) // show only public files (adjust if needed)\n        .map(f => {\n            const fileUrl = (f.file_url || '').split('?')[0];\n            const name = fileUrl.split('/').pop();\n            const label = frappe.utils.escape_html(f.file_name || name);\n            const targetUrl = getTargetUrl(name, stamp, signature);\n            return `<li style=\"margin:4px 0\">\n        <a href=\"${targetUrl}\" target=\"_blank\" rel=\"noopener\">${label}</a>\n      </li>`;\n        });\n\n    html.$wrapper.html(\n        items.length\n            ? `<div><strong>Open in Media Editor</strong><ul style=\"padding-left:18px; list-style:disc\">${items.join('')}</ul></div>`\n            : `<div class=\"text-muted\">No public attachments.</div>`\n    );\n}\n\n// --- NEW: Hijack clicks on the sidebar attachments ---\nfunction extract_filename_from_href(href) {\n    try {\n        if (!href) return null;\n        const u = new URL(href, window.location.origin);\n\n        // Public files like /files/abc.png\n        if (u.pathname.startsWith('/files/')) {\n            return u.pathname.split('/').pop();\n        }\n\n        // Private download endpoint: /api/method/...download_file?file_url=/private/files/abc.png\n        if (u.pathname.includes('/api/method/frappe.utils.file_manager.download_file')) {\n            const p = u.searchParams.get('file_url') || '';\n            if (p) return p.split('/').pop();\n        }\n\n        // Fallback\n        return href.split('/').pop().split('?')[0];\n    } catch (e) {\n        return null;\n    }\n}\n\nasync function bind_sidebar_redirect(frm) {\n    if (frm._bound_media_redirect) return; // avoid double binding\n    frm._bound_media_redirect = true;\n\n    const { stamp, signature } = await get_user_credentials();\n\n    // Delegate clicks from the form wrapper (survives re-renders)\n    frm.$wrapper.on('click',\n        '.form-sidebar .form-attachments a, .form-sidebar .attachments a',\n        function (e) {\n            console.log(\"clicking!!!\");\n            const href = this.getAttribute('href') || '';\n            // Skip if no href (delete buttons etc.)\n            if (!href || (!stamp && !sign)) return;\n\n            // Treat private files normally (don’t hijack)\n            const isPrivate = href.includes('/private/files/') || href.includes('download_file');\n            if (isPrivate) return;\n            e.preventDefault();\n            window.open(getTargetUrl(href, stamp, signature), '_blank');\n        }\n    );\n}\n\nfrappe.ui.form.on('Inbox', {\n    refresh(frm) {\n        // Optional: render your extra link list (if you added the HTML field)\n        render_media_links(frm);\n\n        // Important: hijack sidebar attachment clicks\n        bind_sidebar_redirect(frm);\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Outbox",
  "enabled": 1,
  "modified": "2025-08-31 12:00:10.591623",
  "module": null,
  "name": "Media attachment url redirect outbox",
  "script": "// --- OPTIONAL: keep your custom list in an HTML field (if you added it) ---\nfunction render_media_links(frm) {\n  const html = frm.get_field('media_links');\n  console.log(\"html\" + html);\n  if (!html) return;\n\n  const files = (frm.attachments && frm.attachments.get_attachments)\n    ? frm.attachments.get_attachments()\n    : [];\n\n  const items = files\n    .filter(f => !f.is_private) // show only public files (adjust if needed)\n    .map(f => {\n      const fileUrl = (f.file_url || '').split('?')[0];\n      const name = fileUrl.split('/').pop();\n      const label = frappe.utils.escape_html(f.file_name || name);\n      const targetUrl = `/media-editor/?path=${encodeURIComponent(name)}`;\n      return `<li style=\"margin:4px 0\">\n        <a href=\"${targetUrl}\" target=\"_blank\" rel=\"noopener\">${label}</a>\n      </li>`;\n    });\n\n  html.$wrapper.html(\n    items.length\n      ? `<div><strong>Open in Media Editor</strong><ul style=\"padding-left:18px; list-style:disc\">${items.join('')}</ul></div>`\n      : `<div class=\"text-muted\">No public attachments.</div>`\n  );\n}\n\n// --- NEW: Hijack clicks on the sidebar attachments ---\nfunction extract_filename_from_href(href) {\n  try {\n    if (!href) return null;\n    const u = new URL(href, window.location.origin);\n\n    // Public files like /files/abc.png\n    if (u.pathname.startsWith('/files/')) {\n      return u.pathname.split('/').pop();\n    }\n\n    // Private download endpoint: /api/method/...download_file?file_url=/private/files/abc.png\n    if (u.pathname.includes('/api/method/frappe.utils.file_manager.download_file')) {\n      const p = u.searchParams.get('file_url') || '';\n      if (p) return p.split('/').pop();\n    }\n\n    // Fallback\n    return href.split('/').pop().split('?')[0];\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction bind_sidebar_redirect(frm) {\n  if (frm._bound_media_redirect) return; // avoid double binding\n  frm._bound_media_redirect = true;\n\n  // Delegate clicks from the form wrapper (survives re-renders)\n  frm.$wrapper.on('click',\n    '.form-sidebar .form-attachments a, .form-sidebar .attachments a',\n    function (e) {\n      const href = this.getAttribute('href') || '';\n      // Skip if no href (delete buttons etc.)\n      if (!href) return;\n\n      // Treat private files normally (don’t hijack)\n      const isPrivate = href.includes('/private/files/') || href.includes('download_file');\n      if (isPrivate) return;\n\n      const filename = extract_filename_from_href(href);\n      if (!filename) return;\n\n      e.preventDefault();\n      window.open(`/media-editor/?path=${encodeURIComponent(filename)}`, '_blank');\n    }\n  );\n}\n\nfrappe.ui.form.on('Outbox', {\n  refresh(frm) {\n    // Optional: render your extra link list (if you added the HTML field)\n    render_media_links(frm);\n\n    // Important: hijack sidebar attachment clicks\n    bind_sidebar_redirect(frm);\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 0,
  "modified": "2025-11-03 12:04:34.084483",
  "module": null,
  "name": "restrict sham cach length and only digits",
  "script": "frappe.ui.form.on('Employee', {\n    // Run validation when the custom_sham_cach field loses focus\n    custom_sham_cach: function(frm) {\n        validate_custom_sham_cach(frm);\n    },\n    \n    // Run validation when the form is about to be saved\n    validate: function(frm) {\n        validate_custom_sham_cach(frm);\n    }\n});\n\n// Separate function to avoid code duplication\nfunction validate_custom_sham_cach(frm) {\n    // Get the value\n    let cach_value = frm.doc.custom_sham_cach;\n    \n    // Check if it's not empty\n    if (cach_value) {\n        // Check if it contains only digits AND is exactly 12 characters long\n        if (!/^\\d{12}$/.test(cach_value)) {\n            // Show an error message\n            frappe.throw(__(\"Sham Cach must contain exactly 12 digits.\"));\n            // Clear the invalid value\n            frm.set_value('custom_sham_cach', '');\n        }\n    }\n    // If it's empty, no validation is needed (assuming empty is allowed)\n    // If you want to enforce that it cannot be empty, add an else block here.\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Request_permit",
  "enabled": 1,
  "modified": "2025-09-02 13:19:53.801877",
  "module": null,
  "name": "Media attachment url redirect request_permit",
  "script": "// --- OPTIONAL: keep your custom list in an HTML field (if you added it) ---\nfunction render_media_links(frm) {\n  const html = frm.get_field('media_links');\n  if (!html) return;\n\n  const files = (frm.attachments && frm.attachments.get_attachments)\n    ? frm.attachments.get_attachments()\n    : [];\n\n  const items = files\n    .filter(f => !f.is_private) // show only public files (adjust if needed)\n    .map(f => {\n      const fileUrl = (f.file_url || '').split('?')[0];\n      const name = fileUrl.split('/').pop();\n      const label = frappe.utils.escape_html(f.file_name || name);\n      const targetUrl = `/media-editor/?path=${encodeURIComponent(name)}`;\n      return `<li style=\"margin:4px 0\">\n        <a href=\"${targetUrl}\" target=\"_blank\" rel=\"noopener\">${label}</a>\n      </li>`;\n    });\n\n  html.$wrapper.html(\n    items.length\n      ? `<div><strong>Open in Media Editor</strong><ul style=\"padding-left:18px; list-style:disc\">${items.join('')}</ul></div>`\n      : `<div class=\"text-muted\">No public attachments.</div>`\n  );\n}\n\n// --- NEW: Hijack clicks on the sidebar attachments ---\nfunction extract_filename_from_href(href) {\n  try {\n    if (!href) return null;\n    const u = new URL(href, window.location.origin);\n\n    // Public files like /files/abc.png\n    if (u.pathname.startsWith('/files/')) {\n      return u.pathname.split('/').pop();\n    }\n\n    // Private download endpoint: /api/method/...download_file?file_url=/private/files/abc.png\n    if (u.pathname.includes('/api/method/frappe.utils.file_manager.download_file')) {\n      const p = u.searchParams.get('file_url') || '';\n      if (p) return p.split('/').pop();\n    }\n\n    // Fallback\n    return href.split('/').pop().split('?')[0];\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction bind_sidebar_redirect(frm) {\n  if (frm._bound_media_redirect) return; // avoid double binding\n  frm._bound_media_redirect = true;\n\n  // Delegate clicks from the form wrapper (survives re-renders)\n  frm.$wrapper.on('click',\n    '.form-sidebar .form-attachments a, .form-sidebar .attachments a',\n    function (e) {\n      const href = this.getAttribute('href') || '';\n      // Skip if no href (delete buttons etc.)\n      if (!href) return;\n\n      // Treat private files normally (don’t hijack)\n      const isPrivate = href.includes('/private/files/') || href.includes('download_file');\n      if (isPrivate) return;\n\n      const filename = extract_filename_from_href(href);\n      if (!filename) return;\n\n      e.preventDefault();\n      window.open(`/media-editor/?path=${encodeURIComponent(filename)}`, '_blank');\n    }\n  );\n}\n\n\nfrappe.ui.form.on('Request_permit', {\n  refresh(frm) {\n    // Optional: render your extra link list (if you added the HTML field)\n    render_media_links(frm);\n\n    // Important: hijack sidebar attachment clicks\n    bind_sidebar_redirect(frm);\n  }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "diwan",
  "enabled": 1,
  "modified": "2025-09-02 13:28:54.345085",
  "module": null,
  "name": "Media attachment url redirect diwan",
  "script": "// --- OPTIONAL: keep your custom list in an HTML field (if you added it) ---\nfunction render_media_links(frm) {\n  const html = frm.get_field('media_links');\n  if (!html) return;\n\n  const files = (frm.attachments && frm.attachments.get_attachments)\n    ? frm.attachments.get_attachments()\n    : [];\n\n  const items = files\n    .filter(f => !f.is_private) // show only public files (adjust if needed)\n    .map(f => {\n      const fileUrl = (f.file_url || '').split('?')[0];\n      const name = fileUrl.split('/').pop();\n      const label = frappe.utils.escape_html(f.file_name || name);\n      const targetUrl = `/media-editor/?path=${encodeURIComponent(name)}`;\n      return `<li style=\"margin:4px 0\">\n        <a href=\"${targetUrl}\" target=\"_blank\" rel=\"noopener\">${label}</a>\n      </li>`;\n    });\n\n  html.$wrapper.html(\n    items.length\n      ? `<div><strong>Open in Media Editor</strong><ul style=\"padding-left:18px; list-style:disc\">${items.join('')}</ul></div>`\n      : `<div class=\"text-muted\">No public attachments.</div>`\n  );\n}\n\n// --- NEW: Hijack clicks on the sidebar attachments ---\nfunction extract_filename_from_href(href) {\n  try {\n    if (!href) return null;\n    const u = new URL(href, window.location.origin);\n\n    // Public files like /files/abc.png\n    if (u.pathname.startsWith('/files/')) {\n      return u.pathname.split('/').pop();\n    }\n\n    // Private download endpoint: /api/method/...download_file?file_url=/private/files/abc.png\n    if (u.pathname.includes('/api/method/frappe.utils.file_manager.download_file')) {\n      const p = u.searchParams.get('file_url') || '';\n      if (p) return p.split('/').pop();\n    }\n\n    // Fallback\n    return href.split('/').pop().split('?')[0];\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction bind_sidebar_redirect(frm) {\n  if (frm._bound_media_redirect) return; // avoid double binding\n  frm._bound_media_redirect = true;\n\n  // Delegate clicks from the form wrapper (survives re-renders)\n  frm.$wrapper.on('click',\n    '.form-sidebar .form-attachments a, .form-sidebar .attachments a',\n    function (e) {\n      const href = this.getAttribute('href') || '';\n      // Skip if no href (delete buttons etc.)\n      if (!href) return;\n\n      // Treat private files normally (don’t hijack)\n      const isPrivate = href.includes('/private/files/') || href.includes('download_file');\n      if (isPrivate) return;\n\n      const filename = extract_filename_from_href(href);\n      if (!filename) return;\n\n      e.preventDefault();\n      window.open(`/media-editor/?path=${encodeURIComponent(filename)}`, '_blank');\n    }\n  );\n}\n\nfrappe.ui.form.on('diwan', {\n  refresh(frm) {\n    // Optional: render your extra link list (if you added the HTML field)\n    render_media_links(frm);\n\n    // Important: hijack sidebar attachment clicks\n    bind_sidebar_redirect(frm);\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Entities",
  "enabled": 1,
  "modified": "2025-09-02 13:30:20.306510",
  "module": null,
  "name": "Media attachment url redirect entities",
  "script": "// --- OPTIONAL: keep your custom list in an HTML field (if you added it) ---\nfunction render_media_links(frm) {\n  const html = frm.get_field('media_links');\n  if (!html) return;\n\n  const files = (frm.attachments && frm.attachments.get_attachments)\n    ? frm.attachments.get_attachments()\n    : [];\n\n  const items = files\n    .filter(f => !f.is_private) // show only public files (adjust if needed)\n    .map(f => {\n      const fileUrl = (f.file_url || '').split('?')[0];\n      const name = fileUrl.split('/').pop();\n      const label = frappe.utils.escape_html(f.file_name || name);\n      const targetUrl = `/media-editor/?path=${encodeURIComponent(name)}`;\n      return `<li style=\"margin:4px 0\">\n        <a href=\"${targetUrl}\" target=\"_blank\" rel=\"noopener\">${label}</a>\n      </li>`;\n    });\n\n  html.$wrapper.html(\n    items.length\n      ? `<div><strong>Open in Media Editor</strong><ul style=\"padding-left:18px; list-style:disc\">${items.join('')}</ul></div>`\n      : `<div class=\"text-muted\">No public attachments.</div>`\n  );\n}\n\n// --- NEW: Hijack clicks on the sidebar attachments ---\nfunction extract_filename_from_href(href) {\n  try {\n    if (!href) return null;\n    const u = new URL(href, window.location.origin);\n\n    // Public files like /files/abc.png\n    if (u.pathname.startsWith('/files/')) {\n      return u.pathname.split('/').pop();\n    }\n\n    // Private download endpoint: /api/method/...download_file?file_url=/private/files/abc.png\n    if (u.pathname.includes('/api/method/frappe.utils.file_manager.download_file')) {\n      const p = u.searchParams.get('file_url') || '';\n      if (p) return p.split('/').pop();\n    }\n\n    // Fallback\n    return href.split('/').pop().split('?')[0];\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction bind_sidebar_redirect(frm) {\n  if (frm._bound_media_redirect) return; // avoid double binding\n  frm._bound_media_redirect = true;\n\n  // Delegate clicks from the form wrapper (survives re-renders)\n  frm.$wrapper.on('click',\n    '.form-sidebar .form-attachments a, .form-sidebar .attachments a',\n    function (e) {\n      const href = this.getAttribute('href') || '';\n      // Skip if no href (delete buttons etc.)\n      if (!href) return;\n\n      // Treat private files normally (don’t hijack)\n      const isPrivate = href.includes('/private/files/') || href.includes('download_file');\n      if (isPrivate) return;\n\n      const filename = extract_filename_from_href(href);\n      if (!filename) return;\n\n      e.preventDefault();\n      window.open(`/media-editor/?path=${encodeURIComponent(filename)}`, '_blank');\n    }\n  );\n}\n\nfrappe.ui.form.on('Entities', {\n  refresh(frm) {\n    // Optional: render your extra link list (if you added the HTML field)\n    render_media_links(frm);\n\n    // Important: hijack sidebar attachment clicks\n    bind_sidebar_redirect(frm);\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "File",
  "enabled": 0,
  "modified": "2025-10-19 10:55:44.890862",
  "module": null,
  "name": "hide is private",
  "script": "// Hide \"Is Private\" in all file upload dialogs\n$(document).on('show.bs.modal', '.modal-file-uploader', function () {\n    const modal = $(this);\n    setTimeout(() => {\n        modal.find('[data-fieldname=\"is_private\"]').closest('.form-group').hide();\n    }, 300);\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Correspondence Request",
  "enabled": 0,
  "modified": "2025-10-19 10:57:02.360899",
  "module": "MOI",
  "name": "insert username to sender field",
  "script": "frappe.ui.form.on('Correspondence Request', {\n\tbefore_save(frm) {\n\t\tif (frm.is_new()) {\n            frm.set_value('sender', frm.doc.owner);\n        }\n\t}\n})\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Weekly report and media planning",
  "enabled": 1,
  "modified": "2025-10-14 12:54:23.221943",
  "module": "MOI",
  "name": "rtl",
  "script": "frappe.ui.form.on('Report-all', {\r\n    refresh: function(frm) {\r\n        frm.fields.forEach(field => {\r\n            if (field.df && ['Data', 'Text', 'Small Text', 'Select'].includes(field.df.fieldtype)) {\r\n                let input = $(field.$wrapper).find('input, textarea, select');\r\n                input.css('direction', 'rtl');\r\n                input.css('text-align', 'right');\r\n            }\r\n        });\r\n\r\n        // تعديل اتجاه العناوين والأقسام\r\n        $('.form-section').css({'direction': 'rtl', 'text-align': 'right'});\r\n        $('.form-column').css({'direction': 'rtl', 'text-align': 'right'});\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "User",
  "enabled": 0,
  "modified": "2025-10-19 10:56:34.816255",
  "module": "Press Affairs",
  "name": "add jounalist profile form",
  "script": "frappe.ui.form.on('User', {\n    refresh: function(frm) {\n        // Wait for DOM to load\n        setTimeout(() => {\n            const resetPasswordSection = document.querySelector('div:has(> h4:contains(\"Reset Password\"))') \n                || document.querySelector('div:has(> strong:contains(\"Reset Password\"))');\n            \n            if (!resetPasswordSection) return;\n\n            // Create new row\n            const newRow = document.createElement('div');\n            newRow.style = 'padding: 15px 0; border-bottom: 1px solid #eee; margin-bottom: 10px;';\n            newRow.innerHTML = `\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong>My Profile Form</strong><br>\n                        <span style=\"font-size: 0.9em; color: #777;\">Complete or update your profile information</span>\n                    </div>\n                    <a href=\"/my-profile\" class=\"btn btn-primary\" style=\"background-color: #3498db; color: white; padding: 6px 12px; text-decoration: none; border-radius: 4px; font-weight: 600;\">\n                        Open Form\n                    </a>\n                </div>\n            `;\n\n            // Insert before Reset Password section\n            resetPasswordSection.parentNode.insertBefore(newRow, resetPasswordSection);\n        }, 500);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Internal request",
  "enabled": 1,
  "modified": "2025-11-04 11:52:45.840485",
  "module": "MOI",
  "name": "Media attachment url redirect Internal request",
  "script": "/**\n * Enhanced Media Editor integration for attachments in specific doctypes\n * Doctypes: Internal Request, A, B\n */\n\nasync function get_user_credentials() {\n    try {\n        const user = frappe.session.user;\n        const { message } = await frappe.db.get_value('User', user, ['stamp', 'signature']);\n        return {\n            stamp: message?.stamp || '',\n            sign: message?.signature || ''\n        };\n    } catch (error) {\n        console.error('Failed to fetch user credentials:', error);\n        return { stamp: '', sign: '' };\n    }\n}\n\nfunction extract_filename_from_href(href) {\n    try {\n        if (!href) return null;\n        const url = new URL(href, window.location.origin);\n\n        if (url.pathname.startsWith('/files/')) {\n            return url.pathname.split('/').pop();\n        }\n\n        if (url.pathname.includes('/api/method/frappe.utils.file_manager.download_file')) {\n            const param = url.searchParams.get('file_url');\n            return param ? param.split('/').pop() : null;\n        }\n\n        return href.split('/').pop().split('?')[0];\n    } catch {\n        return null;\n    }\n}\n\nasync function open_in_media_editor(filename, stamp, sign) {\n    const link = `/media-editor/?path=${encodeURIComponent(filename)}&stamp=${encodeURIComponent(stamp)}&sign=${encodeURIComponent(sign)}`;\n    window.open(link, '_blank', 'noopener');\n}\n\nfunction render_media_links(frm) {\n    const htmlField = frm.get_field('media_links');\n    if (!htmlField) return;\n\n    const attachments = frm.attachments?.get_attachments?.() || [];\n    const publicFiles = attachments.filter(f => !f.is_private);\n\n    const listItems = publicFiles.map(f => {\n        const name = (f.file_url || '').split('/').pop();\n        const label = frappe.utils.escape_html(f.file_name || name);\n        return `<li style=\"margin:4px 0\">\n      <a href=\"#\" class=\"media-link\" data-filename=\"${encodeURIComponent(name)}\">${label}</a>\n    </li>`;\n    });\n\n    const html = listItems.length\n        ? `<div><strong>Open in Media Editor</strong><ul style=\"padding-left:18px; list-style:disc\">${listItems.join('')}</ul></div>`\n        : `<div class=\"text-muted\">No public attachments.</div>`;\n\n    htmlField.$wrapper.html(html);\n\n    // Bind custom click handler\n    htmlField.$wrapper.find('.media-link').on('click', async function (e) {\n        e.preventDefault();\n        if (!filename || !(stamp || sign)) return;\n        const filename = decodeURIComponent(this.dataset.filename);\n        await open_in_media_editor(filename, stamp, sign);\n    });\n}\n\nfunction bind_sidebar_redirect(frm) {\n    if (frm._bound_media_redirect) return;\n    frm._bound_media_redirect = true;\n\n    frm.$wrapper.on('click', '.form-sidebar .form-attachments a, .form-sidebar .attachments a', async function (e) {\n        const href = this.getAttribute('href');\n        if (!href || href.includes('/private/files/') || href.includes('download_file')) return;\n\n        const filename = extract_filename_from_href(href);\n        const { stamp, sign } = await get_user_credentials();\n        if (!filename || !(stamp || sign)) return;\n\n        e.preventDefault();\n        await open_in_media_editor(filename, stamp, sign);\n    });\n}\n\nconst doctypes = ['Internal request', 'A', 'B'];\n\ndoctypes.forEach(dt => {\n    frappe.ui.form.on(dt, {\n        async refresh(frm) {\n            render_media_links(frm);\n            bind_sidebar_redirect(frm);\n        }\n    });\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Journalists - Influencers Profile",
  "enabled": 1,
  "modified": "2025-11-02 12:13:51.714292",
  "module": null,
  "name": "add UserName",
  "script": "frappe.ui.form.on('Journalists - Influencers Profile', {\n\t onload: function(frm) {\n        if (frm.is_new()) {\n            frm.set_value('user', frappe.session.user);\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Weekly report and media planning",
  "enabled": 1,
  "modified": "2025-11-05 13:33:15.683507",
  "module": "MOI",
  "name": "filter",
  "script": "frappe.ui.form.on('Weekly report and media planning', {\r\n    onload: function(frm) {\r\n        set_entity_query(frm);\r\n    },\r\n    refresh: function(frm) {\r\n        set_entity_query(frm);\r\n    },\r\n    news_add: function(frm, cdt, cdn) {\r\n        set_entity_query(frm);\r\n    }\r\n});\r\n\r\nfunction set_entity_query(frm) {\r\n    frm.fields_dict.news.grid.get_field('name_of_the_entity').get_query = function(doc, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (!row.type) return;\r\n\r\n        let keyword = row.type === \"وزارة\" ? \"وزارة\" : \"مديرية\";\r\n\r\n        return {\r\n            filters: [\r\n                [\"Ministries and Governorates\", \"ministries_governorates\", \"like\", \"%\" + keyword + \"%\"]\r\n            ]\r\n        };\r\n    };\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Evaluation_post",
  "enabled": 1,
  "modified": "2025-11-12 14:18:43.630177",
  "module": "MOI",
  "name": "trigger 8n8",
  "script": "frappe.ui.form.on('Evaluation_post', {\r\n    search(frm) {\r\n        frappe.call({\r\n            method: \"frappe.client.insert\",\r\n            args: {\r\n                doc: {\r\n                    doctype: \"Evaluation_post\",\r\n                    key_word: frm.doc.key_word,\r\n                    page: frm.doc.page\r\n                }\r\n            },\r\n            callback: function(r) {\r\n                if (!r.exc) {\r\n                    frappe.msgprint(\"✅ New Evaluation_post created: \" + r.message.name);\r\n                    // Redirect after successful insert\r\n                    window.location.href = \"https://moi-mis.gov.sy/app/social-interactions\";\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Task",
  "enabled": 1,
  "modified": "2025-11-20 12:04:41.078163",
  "module": "Press Affairs",
  "name": "Kanban Board For Task",
  "script": "frappe.listview_settings['Task'] = {\r\n    onload: function(listview) {\r\n        listview.page.set_primary_action(__('Kanban by Workflow State'), function() {\r\n            frappe.set_route('List', 'Task', 'Kanban', 'workflow_state');\r\n        });\r\n    }\r\n};\r\n",
  "view": "List"
 }
]