[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Attendance",
  "enabled": 1,
  "modified": "2025-12-23 12:32:01.427284",
  "module": "fingerprint",
  "name": "get checkins",
  "script": "frappe.listview_settings['Attendance'] = {\n    onload: function (listview) {\n        // Fetch app path once (cached)\n        let APP_PATH = null;\n\n        const getAppPath = async () => {\n            if (APP_PATH) return APP_PATH;\n\n            try {\n                const r = await frappe.call({\n                    method: 'fingerprint.api.utils.get_app_info',\n                    freeze: false\n                });\n                if (r.message && r.message.app_path) {\n                    APP_PATH = r.message.app_path;\n                    console.log('✅ Fingerprint app path:', APP_PATH);\n                    return APP_PATH;\n                } else {\n                    throw new Error('App path not returned');\n                }\n            } catch (e) {\n                frappe.show_alert({\n                    message: __('⚠️ Using fallback path — app info not available'),\n                    indicator: 'orange'\n                }, 5);\n                console.warn('Falling back to default app path structure');\n                // Fallback: construct path assuming standard bench layout\n                // e.g., site = 'moi-mis.gov.sy' → user = 'moi-mis'\n                const site = frappe.boot.site || 'moi-mis.gov.sy';\n                const user = site.split('.')[0]; // 'moi-mis'\n                APP_PATH = `/home/${user}/frappe-bench/apps/fingerprint`;\n                return APP_PATH;\n            }\n        };\n\n        // Button 1: Fetch Checkins (unchanged)\n        listview.page.add_button(__('Fetch Checkins'), () => {\n            const d = new frappe.ui.Dialog({\n                title: __('Fetch Checkins'),\n                fields: [\n                    {\n                        label: __('Import Start Date'),\n                        fieldname: 'import_start_date',\n                        fieldtype: 'Date',\n                        reqd: 1,\n                        default: frappe.datetime.add_days(frappe.datetime.nowdate(), -7)\n                    },\n                    {\n                        label: __('Import End Date'),\n                        fieldname: 'import_end_date',\n                        fieldtype: 'Date',\n                        reqd: 1,\n                        default: frappe.datetime.nowdate()\n                    }\n                ],\n                primary_action_label: __('Fetch'),\n                primary_action: function (values) {\n                    frappe.call({\n                        method: 'fingerprint.api.fetch_checkins.fetch_checkins',\n                        args: {\n                            import_start_date: values.import_start_date,\n                            import_end_date: values.import_end_date\n                        },\n                        freeze: true,\n                        freeze_message: __('Fetching check-ins, please wait...'),\n                        callback: function (r) {\n                            if (!r.exc) {\n                                frappe.msgprint(__('✅ Check-ins fetched successfully'));\n                                d.hide();\n                                listview.refresh();\n                            } else {\n                                let error_msg = r.exc || __('Unknown error');\n                                if (error_msg.includes('Traceback')) {\n                                    const lines = error_msg.split('\\n');\n                                    const errorLine = lines.find(line =>\n                                        line.includes('Exception:') ||\n                                        line.includes('Error:') ||\n                                        (line.trim() && !line.startsWith(' '))\n                                    );\n                                    error_msg = errorLine ? errorLine.trim() : __('Operation failed.');\n                                }\n                                frappe.msgprint({\n                                    title: __('❌ Fetch Failed'),\n                                    indicator: 'red',\n                                    message: __('Failed to fetch check-ins: {0}', [error_msg])\n                                });\n                                console.error('Fetch error:', r.exc);\n                            }\n                        }\n                    });\n                }\n            });\n            d.show();\n        });\n\n        // Button 2: Mark Attendance (unchanged)\n        listview.page.add_button(__('Mark Attendance'), () => {\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Shift Type',\n                    fields: ['name'],\n                    order_by: 'name'\n                },\n                callback: function (r) {\n                    if (r.message && r.message.length > 0) {\n                        const shift_options = ['All Shifts'].concat(r.message.map(s => s.name));\n                        const d = new frappe.ui.Dialog({\n                            title: __('Mark Attendance'),\n                            fields: [\n                                {\n                                    label: __('Select Shift Type'),\n                                    fieldname: 'shift_type',\n                                    fieldtype: 'Select',\n                                    options: shift_options,\n                                    default: 'All Shifts',\n                                    reqd: 1\n                                },\n                                {\n                                    label: __('Process attendance after'),\n                                    fieldname: 'process_attendance_after',\n                                    fieldtype: 'Date',\n                                    reqd: 1,\n                                    default: frappe.datetime.add_days(frappe.datetime.nowdate(), -30)\n                                },\n                                {\n                                    label: __('Last sync of checkin'),\n                                    fieldname: 'last_sync_of_checkin',\n                                    fieldtype: 'Datetime',\n                                    reqd: 1,\n                                    default: frappe.datetime.now_datetime()\n                                }\n                            ],\n                            primary_action_label: __('Process'),\n                            primary_action: function (values) {\n                                d.hide();\n                                frappe.call({\n                                    method: 'fingerprint.api.mark_attendance.process_auto_attendance_for_all_shifts',\n                                    args: {\n                                        process_attendance_after: values.process_attendance_after,\n                                        last_sync_of_checkin: values.last_sync_of_checkin,\n                                        shift_type: values.shift_type === 'All Shifts' ? '' : values.shift_type\n                                    },\n                                    freeze: true,\n                                    freeze_message: __('Marking attendance...'),\n                                    callback: function (r) {\n                                        if (!r.exc) {\n                                            frappe.msgprint(__('✅ Attendance marked for: {0}', [values.shift_type]));\n                                        } else {\n                                            frappe.msgprint(__('❌ Failed: ') + (r.exc || 'Unknown error'));\n                                        }\n                                        listview.refresh();\n                                    }\n                                });\n                            }\n                        });\n                        d.show();\n                    } else {\n                        frappe.msgprint(__('No Shift Types found. Create one first.'));\n                    }\n                }\n            });\n        });\n\n        // Button 3: Fetch & Upload (✅ Updated with dynamic app path)\n        listview.page.add_inner_button(__('Fetch & Upload'), async function () {\n            loadJSZipAndFileSaver(async function () {\n                const companies = await frappe.db.get_list('Company', {\n                    fields: ['name'],\n                    order_by: 'name'\n                }).catch(() => []);\n\n                const dialog = new frappe.ui.Dialog({\n                    title: __('Enter Configuration'),\n                    fields: [\n                        {\n                            label: __('Company'),\n                            fieldname: 'company',\n                            fieldtype: 'Link',\n                            options: 'Company',\n                            reqd: 1,\n                            default: frappe.defaults.get_default('company') || (companies.length ? companies[0].name : '')\n                        },\n                        {\n                            label: __('Device IPs'),\n                            fieldname: 'device_ips',\n                            fieldtype: 'Data',\n                            default: localStorage.getItem('fingerprint_device_ips') || '',\n                            description: __('Comma-separated, e.g., 192.168.1.10, 192.168.1.11'),\n                            reqd: 1\n                        },\n                        {\n                            label: __('Username'),\n                            fieldname: 'username',\n                            fieldtype: 'Data',\n                            reqd: 1,\n                            default: frappe.session.user\n                        },\n                        {\n                            label: __('Password'),\n                            fieldname: 'password',\n                            fieldtype: 'Password',\n                            reqd: 1\n                        }\n                    ],\n                    primary_action_label: __('Generate & Download ZIP'),\n                    primary_action: async function (values) {\n                        dialog.hide();\n\n                        try {\n                            // ✅ Get app path dynamically\n                            const appPath = await getAppPath();\n                            const main_file_path = `${appPath}/fingerprint/api/get_fingerprint_data.py`;\n                            const extra_file_path = `${appPath}/fingerprint/api/run_python.bat`;\n\n                            const zip = new JSZip();\n\n                            // Read main file\n                            const mainRes = await frappe.call({\n                                method: 'fingerprint.api.read_file_from_server.read_server_file',\n                                args: { file_path: main_file_path }\n                            });\n\n                            if (!mainRes.message) throw new Error(__('Main config file not found'));\n\n                            let content = mainRes.message.content\n                                .replace(/USERNAME/g, values.username)\n                                .replace(/PASSWORD/g, values.password)\n                                .replace(/COMPANY/g, values.company)\n                                .replace(/IPs/g, values.device_ips);\n\n                            zip.file(mainRes.message.file_name, content);\n\n                            // Optional: extra file\n                            try {\n                                const extraRes = await frappe.call({\n                                    method: 'fingerprint.api.read_file_from_server.read_server_file',\n                                    args: { file_path: extra_file_path }\n                                });\n                                if (extraRes.message) {\n                                    zip.file(extraRes.message.file_name, extraRes.message.content);\n                                }\n                            } catch (e) {\n                                console.warn('Extra file not found, skipping');\n                            }\n\n                            // Download\n                            const blob = await zip.generateAsync({ type: 'blob' });\n                            const filename = `fingerprint_config_${values.company.replace(/\\s+/g, '_')}.zip`;\n                            saveAs(blob, filename);\n                            frappe.msgprint(__('✅ ZIP generated for {0}', [values.company]));\n\n                            // Save IPs\n                            localStorage.setItem('fingerprint_device_ips', values.device_ips);\n\n                        } catch (err) {\n                            frappe.msgprint(__('❌ Error: {0}', [err.message || err]));\n                            console.error('ZIP generation error:', err);\n                        }\n                    }\n                });\n                dialog.show();\n            });\n        });\n\n        // Button 4: Export to Excel (unchanged)\n        listview.page.add_inner_button(__('Export to Excel'), async function () {\n            loadSheetJS(() => {\n                try {\n                    const data = listview.data;\n                    if (!data || data.length === 0) {\n                        frappe.msgprint(__('No data to export'));\n                        return;\n                    }\n\n                    const export_data = data.map(row => ({\n                        'Employee': row.employee,\n                        'Employee Name': row.employee_name,\n                        'Attendance Date': frappe.datetime.str_to_user(row.attendance_date),\n                        'Status': row.status,\n                        'In Time': row.in_time || '',\n                        'Out Time': row.out_time || '',\n                        'Working Hours': (row.total_working_hours || 0).toFixed(2),\n                        'Late Entry (Min)': row.custom_late_entry_in_minutes || 0,\n                        'Early Exit (Min)': row.custom_early_exit_in_minutes || 0\n                    }));\n\n                    const ws = XLSX.utils.json_to_sheet(export_data);\n                    const wb = XLSX.utils.book_new();\n                    XLSX.utils.book_append_sheet(wb, ws, 'Attendance');\n                    XLSX.writeFile(wb, `Attendance_${frappe.datetime.get_today()}.xlsx`);\n\n                    frappe.show_alert(__('Exported successfully'), 'green');\n                } catch (err) {\n                    frappe.msgprint(__('Export failed: ') + err.message);\n                    console.error(err);\n                }\n            });\n        });\n    }\n};\n\n// ==== Utility Functions (unchanged) ====\nfunction loadSheetJS(callback) {\n    if (window.XLSX) return callback();\n    const script = document.createElement('script');\n    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';\n    script.onload = callback;\n    script.onerror = () => frappe.msgprint(__('Failed to load Excel library'));\n    document.head.appendChild(script);\n}\n\nfunction loadJSZipAndFileSaver(callback) {\n    if (window.JSZip && window.saveAs) return callback();\n    loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js', () =>\n        loadScript('https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js', callback)\n    );\n}\n\nfunction loadScript(src, callback) {\n    const script = document.createElement('script');\n    script.src = src;\n    script.onload = callback;\n    script.onerror = () => frappe.throw(__('Failed to load: ') + src);\n    document.head.appendChild(script);\n}",
  "view": "List"
 }
]